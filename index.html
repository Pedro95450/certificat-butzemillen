<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Certificat de formation – Butzemillen</title>

  <!-- Police Avenir -->
  <link href="https://fonts.cdnfonts.com/css/avenir" rel="stylesheet">

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Avenir', sans-serif;
      background-color: #f5f5f7;
      color: #222;
    }

    /* Barre de titre */
    .topbar {
      background: #91268f;
      color: #fff;
      padding: 12px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }

    .topbar-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.4px;
    }

    .topbar-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    .container {
      padding: 18px 24px 30px;
    }

    .layout {
      display: grid;
      grid-template-columns: 420px minmax(0, 1fr);
      gap: 22px;
      align-items: flex-start;
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Panneau formulaire */
    #formulaire {
      background: #ffffff;
      padding: 18px 20px 20px;
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(15,23,42,0.08);
      border: 1px solid #e1e1e6;
      max-height: calc(100vh - 90px);
      overflow-y: auto;
    }

    #formulaire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #formulaire-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: #4b1152;
    }

    #formulaire-header span {
      font-size: 11px;
      color: #666;
    }

    fieldset {
      border: none;
      border-top: 1px solid #eee;
      padding: 12px 0 4px;
      margin: 4px 0 6px;
    }

    fieldset:first-of-type {
      border-top: none;
      padding-top: 4px;
    }

    legend {
      font-size: 12px;
      font-weight: 700;
      color: #91268f;
      padding: 0;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 2px;
      color: #333;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #d5d5dd;
      font-size: 13px;
      outline: none;
      transition: border-color .15s, box-shadow .15s, background-color .15s;
      background-color: #fafafa;
    }

    input:focus,
    select:focus {
      border-color: #91268f;
      box-shadow: 0 0 0 1px rgba(145,38,143,0.18);
      background-color: #fff;
    }

    input[type="file"] {
      font-size: 11px;
    }

    small {
      display: block;
      font-size: 11px;
      color: #777;
      margin-top: 1px;
    }

    .inline {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .inline > div {
      flex: 1;
    }

    .muted {
      font-size: 11px;
      color: #777;
    }

    .chips {
      display: inline-flex;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e0c1e7;
      color: #6a1c6a;
      background: #faf2ff;
      cursor: pointer;
      user-select: none;
    }

    .chip:hover {
      background: #f2e4ff;
    }

    .day-block {
      margin-top: 6px;
    }

    .day-title {
      font-weight: 700;
      font-size: 12px;
      color: #4b1152;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .day-title input[type="checkbox"] {
      margin: 0;
    }

    #total-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 8px;
    }

    #total-line span {
      font-size: 12px;
    }

    #totalHoursDisplay {
      font-weight: 700;
      color: #4b1152;
    }

    #buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      flex: 1;
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      background-color: #91268f;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.16);
      transition: background-color .2s, transform .1s, box-shadow .2s;
      white-space: nowrap;
    }

    button.secondary {
      background-color: #f3ecf7;
      color: #4b1152;
      box-shadow: none;
      border: 1px solid #dfc6ea;
    }

    button:hover {
      background-color: #6d1f6b;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.22);
    }

    button.secondary:hover {
      background-color: #e9dcf5;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transform: translateY(-0.5px);
    }

    /* Carte apercu */
    #preview-wrapper {
      background: #ffffff;
      padding: 10px;
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(15,23,42,0.08);
      border: 1px solid #e1e1e6;
    }

    #preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    #preview-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
      color: #4b1152;
    }

    #preview-header span {
      font-size: 11px;
      color: #777;
    }

    /* Apercu certificat - format A4 paysage (ratio 297:210) */
    #preview {
      position: relative;
      width: 1188px;
      height: 840px;
      background: #ffffff;
      border: 1px solid #d5d5dd;
      overflow: hidden;
    }

    .preview-scroller {
      max-width: 100%;
      overflow: auto;
      border-radius: 10px;
    }

    /* Elements decoratifs */
    .decor-icon {
      position: absolute;
      pointer-events: none;
      user-select: none;
    }

    .decor-circle {
      position: absolute;
      border-radius: 50%;
      background-color: #91268f;
      pointer-events: none;
    }

    /* Couches de texte */
    .text-layer {
      position: absolute;
      pointer-events: none;
      white-space: normal;
      line-height: 1.3;
      font-size: 16px;
      letter-spacing: 0.3px;
      color: #91268f;
      font-family: 'Avenir', sans-serif;
      text-align: left;
    }

    .line-layer {
      position: absolute;
      background: #91268f;
      pointer-events: none;
    }

    .signature-layer {
      position: absolute;
      pointer-events: none;
    }
  </style>
</head>
<body>

<div class="topbar">
  <div>
    <div class="topbar-title">Certificats de formation internes</div>
  </div>
  <div class="topbar-sub">Butzemillen – Creches &amp; foyers de jour</div>
</div>

<div class="container">
  <div class="layout">

    <!-- FORMULAIRE -->
    <div id="formulaire">
      <div id="formulaire-header">
        <h2>Formulaire certificat</h2>
        <span>Jusqu'a 5 jours</span>
      </div>

      <fieldset>
        <legend>1. Informations generales</legend>

        <label for="nomPrenom">Participant(e)s</label>
        <input type="text" id="nomPrenom"
               placeholder="NOM Prenom, NOM Prenom, NOM Prenom" />
        <small>Indiquer le ou les noms, separes par des virgules.</small>

        <label for="formation">Intitule de la formation</label>
        <input type="text" id="formation"
               placeholder="Education non formelle et soins de l'enfant" />
        <div class="chips">
          <span class="chip" onclick="presetFormation('Education non formelle et soins de l\'enfant')">
            Intitule standard
          </span>
        </div>

        <label for="lieuFormation">Lieu de la formation</label>
        <input type="text" id="lieuFormation" placeholder="Ettelbruck" />
      </fieldset>

      <fieldset>
        <legend>2. Seances &amp; duree (max. 5 jours)</legend>
        <small class="muted">Cocher les jours utilises, puis saisir date et horaires.</small>

        <!-- Jour 1 -->
        <div class="day-block">
          <div class="day-title">
            <label>
              <input type="checkbox" id="day1Enable" checked onchange="toggleDay(1)">
              Jour 1
            </label>
          </div>
          <div id="day1Fields" style="display:block;">
            <div class="inline">
              <div>
                <label for="day1Date">Date</label>
                <input type="date" id="day1Date" />
              </div>
              <div>
                <label>Horaires</label>
                <div class="inline" style="gap:4px;">
                  <input type="time" id="day1Start" onchange="updateTotal()" />
                  <input type="time" id="day1End" onchange="updateTotal()" />
                </div>
                <small>Debut – fin</small>
              </div>
            </div>
            <label for="day1Titre">Intitule de la seance</label>
            <input type="text" id="day1Titre" placeholder="Education non formelle" />
          </div>
        </div>

        <!-- Jour 2 -->
        <div class="day-block">
          <div class="day-title">
            <label>
              <input type="checkbox" id="day2Enable" onchange="toggleDay(2)">
              Jour 2 (facultatif)
            </label>
          </div>
          <div id="day2Fields" style="display:none;">
            <div class="inline">
              <div>
                <label for="day2Date">Date</label>
                <input type="date" id="day2Date" />
              </div>
              <div>
                <label>Horaires</label>
                <div class="inline" style="gap:4px;">
                  <input type="time" id="day2Start" onchange="updateTotal()" />
                  <input type="time" id="day2End" onchange="updateTotal()" />
                </div>
                <small>Debut – fin</small>
              </div>
            </div>
            <label for="day2Titre">Intitule de la seance</label>
            <input type="text" id="day2Titre" placeholder="Soins de l'enfant" />
          </div>
        </div>

        <!-- Jour 3 -->
        <div class="day-block">
          <div class="day-title">
            <label>
              <input type="checkbox" id="day3Enable" onchange="toggleDay(3)">
              Jour 3 (facultatif)
            </label>
          </div>
          <div id="day3Fields" style="display:none;">
            <div class="inline">
              <div>
                <label for="day3Date">Date</label>
                <input type="date" id="day3Date" />
              </div>
              <div>
                <label>Horaires</label>
                <div class="inline" style="gap:4px;">
                  <input type="time" id="day3Start" onchange="updateTotal()" />
                  <input type="time" id="day3End" onchange="updateTotal()" />
                </div>
                <small>Debut – fin</small>
              </div>
            </div>
            <label for="day3Titre">Intitule de la seance</label>
            <input type="text" id="day3Titre" placeholder="..." />
          </div>
        </div>

        <!-- Jour 4 -->
        <div class="day-block">
          <div class="day-title">
            <label>
              <input type="checkbox" id="day4Enable" onchange="toggleDay(4)">
              Jour 4 (facultatif)
            </label>
          </div>
          <div id="day4Fields" style="display:none;">
            <div class="inline">
              <div>
                <label for="day4Date">Date</label>
                <input type="date" id="day4Date" />
              </div>
              <div>
                <label>Horaires</label>
                <div class="inline" style="gap:4px;">
                  <input type="time" id="day4Start" onchange="updateTotal()" />
                  <input type="time" id="day4End" onchange="updateTotal()" />
                </div>
                <small>Debut – fin</small>
              </div>
            </div>
            <label for="day4Titre">Intitule de la seance</label>
            <input type="text" id="day4Titre" placeholder="..." />
          </div>
        </div>

        <!-- Jour 5 -->
        <div class="day-block">
          <div class="day-title">
            <label>
              <input type="checkbox" id="day5Enable" onchange="toggleDay(5)">
              Jour 5 (facultatif)
            </label>
          </div>
          <div id="day5Fields" style="display:none;">
            <div class="inline">
              <div>
                <label for="day5Date">Date</label>
                <input type="date" id="day5Date" />
              </div>
              <div>
                <label>Horaires</label>
                <div class="inline" style="gap:4px;">
                  <input type="time" id="day5Start" onchange="updateTotal()" />
                  <input type="time" id="day5End" onchange="updateTotal()" />
                </div>
                <small>Debut – fin</small>
              </div>
            </div>
            <label for="day5Titre">Intitule de la seance</label>
            <input type="text" id="day5Titre" placeholder="..." />
          </div>
        </div>

        <div id="total-line">
          <span class="muted">Duree totale calculee :</span>
          <span id="totalHoursDisplay">0 h</span>
        </div>
      </fieldset>

      <fieldset>
        <legend>3. Signature &amp; date</legend>

        <label for="faitLieu">Lieu de redaction</label>
        <input type="text" id="faitLieu" placeholder="Ettelbruck" />

        <label for="faitDate">Date de redaction</label>
        <input type="date" id="faitDate" />
        <small>Affiche en bas du certificat (« Fait a …, le … »).</small>

        <label for="signName">Nom / fonction du signataire</label>
        <input type="text" id="signName" placeholder="Nom du directeur / de la directrice" />

        <label for="signatureFile">Signature (image)</label>
        <input type="file" id="signatureFile" accept="image/*" onchange="loadSignature(event)">
        <small>Importer une signature scannee (PNG/JPG) sur fond blanc ou transparent.</small>
      </fieldset>

      <div id="buttons">
        <button type="button" class="secondary" onclick="generatePreview()">Mettre a jour l'apercu</button>
        <button type="button" onclick="generatePDF()">Telecharger le PDF</button>
      </div>
    </div>

    <!-- APERCU CERTIFICAT -->
    <div id="preview-wrapper">
      <div id="preview-header">
        <h3>Apercu du certificat</h3>
        <span>Format PDF A4 paysage</span>
      </div>
      <div class="preview-scroller">
        <div id="preview"></div>
      </div>
    </div>

  </div>
</div>

<script>
  /******************************
   * CONFIGURATION
   ******************************/

  // Chemins des images locales
  const ICON_YELLOW = '20251020-icons-butzemillen-03-149.png';
  const LOGO_SVG = '20251020-logo-butzemillen_bm-logo-color-cr-fdj-01.svg';

  // Couleurs
  const PURPLE = '#91268f';
  const YELLOW = '#f6c843';

  // Dimensions du preview (A4 paysage en pixels)
  const PREVIEW_WIDTH = 1188;
  const PREVIEW_HEIGHT = 840;

  // Centre horizontal
  const CENTER_X = PREVIEW_WIDTH / 2;

  // Parametres du tableau
  const TABLE_TOP = 520;
  const TABLE_LEFT = 220;
  const TABLE_WIDTH = 750;
  const ROW_HEIGHT = 32;

  const COL1_WIDTH = 140; // Date
  const COL2_WIDTH = 160; // Horaire
  const COL3_WIDTH = TABLE_WIDTH - COL1_WIDTH - COL2_WIDTH; // Intitule

  // Position signature
  const SIGN_CENTER_X = 950;

  // Stockage signature
  let signatureDataUrl = null;

  /******************************
   * UTILITAIRES
   ******************************/

  function presetFormation(value) {
    document.getElementById('formation').value = value;
    generatePreview();
  }

  function formatDate(isoDateStr) {
    if (!isoDateStr) return '';
    const parts = isoDateStr.split('-');
    if (parts.length < 3) return isoDateStr;
    return parts[2] + '/' + parts[1] + '/' + parts[0];
  }

  function parseTimeToHours(str) {
    if (!str || !str.includes(':')) return 0;
    const [HH, MM] = str.split(':');
    const h = parseInt(HH, 10) || 0;
    const m = parseInt(MM, 10) || 0;
    return h + (m / 60);
  }

  function formatTimeDisplay(str) {
    if (!str || !str.includes(':')) return '';
    const [HH, MM] = str.split(':');
    return `${HH}h${MM}`;
  }

  function calcDayHours(startId, endId) {
    const startStr = document.getElementById(startId).value;
    const endStr = document.getElementById(endId).value;
    const startVal = parseTimeToHours(startStr);
    const endVal = parseTimeToHours(endStr);
    return Math.max(endVal - startVal, 0);
  }

  function updateTotal() {
    let total = 0;
    for (let i = 1; i <= 5; i++) {
      const enable = document.getElementById(`day${i}Enable`).checked;
      if (!enable) continue;
      total += calcDayHours(`day${i}Start`, `day${i}End`);
    }
    total = Math.round(total * 100) / 100;
    const label = total <= 0 ? '0 h' : `${total.toString().replace('.', ',')} h`;
    document.getElementById('totalHoursDisplay').textContent = label;
  }

  function toggleDay(i) {
    const enable = document.getElementById(`day${i}Enable`).checked;
    const fields = document.getElementById(`day${i}Fields`);
    fields.style.display = enable ? 'block' : 'none';

    if (!enable) {
      document.getElementById(`day${i}Date`).value = '';
      document.getElementById(`day${i}Start`).value = '';
      document.getElementById(`day${i}End`).value = '';
      document.getElementById(`day${i}Titre`).value = '';
    }
    updateTotal();
    generatePreview();
  }

  function loadSignature(event) {
    const file = event.target.files[0];
    if (!file) {
      signatureDataUrl = null;
      generatePreview();
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      signatureDataUrl = e.target.result;
      generatePreview();
    };
    reader.readAsDataURL(file);
  }

  /******************************
   * CREATION ELEMENTS PREVIEW
   ******************************/

  function clearPreview() {
    const preview = document.getElementById('preview');
    // Garder uniquement les elements de base
    preview.innerHTML = '';
  }

  function createDecorCircle(x, y, size, opacity = 1) {
    const div = document.createElement('div');
    div.className = 'decor-circle';
    div.style.left = (x - size/2) + 'px';
    div.style.top = (y - size/2) + 'px';
    div.style.width = size + 'px';
    div.style.height = size + 'px';
    div.style.opacity = opacity;
    document.getElementById('preview').appendChild(div);
  }

  function createDecorIcon(src, x, y, width, anchor = 'center') {
    const img = document.createElement('img');
    img.src = src;
    img.className = 'decor-icon';
    img.style.width = width + 'px';

    if (anchor === 'center') {
      img.style.left = (x - width/2) + 'px';
    } else if (anchor === 'left') {
      img.style.left = x + 'px';
    }
    img.style.top = y + 'px';
    document.getElementById('preview').appendChild(img);
  }

  function createTextLayer(htmlContent, x, y, align = 'left', maxWidth = null) {
    const div = document.createElement('div');
    div.className = 'text-layer';
    div.style.top = y + 'px';
    div.innerHTML = htmlContent;

    if (maxWidth) {
      div.style.maxWidth = maxWidth + 'px';
    }

    if (align === 'center') {
      div.style.textAlign = 'center';
      div.style.left = '0px';
      document.getElementById('preview').appendChild(div);
      const w = div.offsetWidth;
      div.style.left = (x - w/2) + 'px';
    } else if (align === 'right') {
      div.style.textAlign = 'right';
      div.style.left = '0px';
      document.getElementById('preview').appendChild(div);
      const w = div.offsetWidth;
      div.style.left = (x - w) + 'px';
    } else {
      div.style.left = x + 'px';
      document.getElementById('preview').appendChild(div);
    }
  }

  function createHLine(x, y, width, color = PURPLE) {
    const div = document.createElement('div');
    div.className = 'line-layer';
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    div.style.width = width + 'px';
    div.style.height = '1px';
    div.style.background = color;
    document.getElementById('preview').appendChild(div);
  }

  function createVLine(x, y, height, color = PURPLE) {
    const div = document.createElement('div');
    div.className = 'line-layer';
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    div.style.width = '1px';
    div.style.height = height + 'px';
    div.style.background = color;
    document.getElementById('preview').appendChild(div);
  }

  function createSignatureImage(centerX, y) {
    if (!signatureDataUrl) return;
    const img = document.createElement('img');
    img.src = signatureDataUrl;
    img.className = 'signature-layer';
    img.style.top = y + 'px';
    img.style.left = '0px';
    img.onload = function() {
      const maxWidth = 180;
      const maxHeight = 80;
      const ratio = img.naturalHeight / img.naturalWidth;
      let w = Math.min(maxWidth, img.naturalWidth);
      let h = w * ratio;
      if (h > maxHeight) {
        h = maxHeight;
        w = h / ratio;
      }
      img.style.width = w + 'px';
      img.style.height = h + 'px';
      img.style.left = (centerX - w/2) + 'px';
    };
    document.getElementById('preview').appendChild(img);
  }

  /******************************
   * COLLECTE DES DONNEES
   ******************************/

  function collectFormData() {
    const nomPrenom = document.getElementById('nomPrenom').value.trim();
    const formation = document.getElementById('formation').value.trim();
    const lieuForm = document.getElementById('lieuFormation').value.trim();
    const faitLieu = document.getElementById('faitLieu').value.trim();
    const faitDate = document.getElementById('faitDate').value.trim();
    const signName = document.getElementById('signName').value.trim();

    const days = [];
    for (let i = 1; i <= 5; i++) {
      const enable = document.getElementById(`day${i}Enable`).checked;
      if (!enable) continue;
      const date = document.getElementById(`day${i}Date`).value.trim();
      const start = document.getElementById(`day${i}Start`).value;
      const end = document.getElementById(`day${i}End`).value;
      const hours = calcDayHours(`day${i}Start`, `day${i}End`);
      const titre = document.getElementById(`day${i}Titre`).value.trim();
      if (!date && !start && !end && !titre) continue;
      days.push({ date, start, end, hours, titre });
    }

    let totalHours = 0;
    days.forEach(d => totalHours += d.hours);
    totalHours = Math.round(totalHours * 100) / 100;

    return {
      nomPrenom,
      formation,
      lieuForm,
      faitLieu,
      faitDate,
      signName,
      days,
      totalHours
    };
  }

  /******************************
   * GENERATION APERCU
   ******************************/

  function generatePreview() {
    clearPreview();

    const {
      nomPrenom,
      formation,
      lieuForm,
      faitLieu,
      faitDate,
      signName,
      days,
      totalHours
    } = collectFormData();

    // Decorations: Cercles violets
    // Grand cercle en bas a gauche (coupe)
    createDecorCircle(-60, PREVIEW_HEIGHT + 60, 300);

    // Cercle moyen a gauche (centre vertical)
    createDecorCircle(-40, 280, 180);

    // Grand cercle en bas a droite (coupe)
    createDecorCircle(PREVIEW_WIDTH + 80, PREVIEW_HEIGHT - 40, 280);

    // Icone jaune en haut a gauche
    createDecorIcon(ICON_YELLOW, -80, -80, 380, 'left');

    // Logo centre en haut
    createDecorIcon(LOGO_SVG, CENTER_X, 30, 220, 'center');

    // Titre "Certificat"
    createTextLayer(
      '<span style="font-size:36px; font-weight:bold;">Certificat</span>',
      CENTER_X, 150, 'center'
    );

    // Sous-titre
    createTextLayer(
      '<span style="font-size:22px;">de formation interne</span>',
      CENTER_X, 195, 'center'
    );

    // Ligne decorative jaune sous le titre
    const lineY = 230;
    const lineWidth = 80;
    const lineDiv = document.createElement('div');
    lineDiv.className = 'line-layer';
    lineDiv.style.left = (CENTER_X - lineWidth/2) + 'px';
    lineDiv.style.top = lineY + 'px';
    lineDiv.style.width = lineWidth + 'px';
    lineDiv.style.height = '3px';
    lineDiv.style.background = YELLOW;
    document.getElementById('preview').appendChild(lineDiv);

    // Texte principal
    createTextLayer(
      '<span><strong>Butzemillen s.a.r.l</strong> certifie que</span>',
      CENTER_X, 270, 'center'
    );

    createTextLayer(
      `<span style="font-weight:bold;">${nomPrenom || 'NOM Prenom, NOM Prenom, NOM Prenom'}</span>`,
      CENTER_X, 310, 'center'
    );

    createTextLayer(
      '<span>ont participe(e)s a la formation intitulee</span>',
      CENTER_X, 350, 'center'
    );

    createTextLayer(
      `<span style="font-weight:bold;">« ${formation || "Education non formelle et soins de l'enfant"} »</span>`,
      CENTER_X, 385, 'center'
    );

    createTextLayer(
      `<span>ayant eu lieu a <strong>${lieuForm || 'Ettelbruck'}</strong>, le :</span>`,
      CENTER_X, 430, 'center'
    );

    // TABLEAU
    const nbRows = Math.max(days.length, 1);
    const tableHeight = ROW_HEIGHT * nbRows;

    // En-tetes du tableau
    const headerY = TABLE_TOP - 25;
    const col1Center = TABLE_LEFT + COL1_WIDTH / 2;
    const col2Center = TABLE_LEFT + COL1_WIDTH + COL2_WIDTH / 2;
    const col3Center = TABLE_LEFT + COL1_WIDTH + COL2_WIDTH + COL3_WIDTH / 2;

    createTextLayer(
      '<span style="font-weight:bold; font-size:14px;">Date</span>',
      col1Center, headerY, 'center'
    );
    createTextLayer(
      '<span style="font-weight:bold; font-size:14px;">Horaire</span>',
      col2Center, headerY, 'center'
    );
    createTextLayer(
      '<span style="font-weight:bold; font-size:14px;">Intitule de la seance</span>',
      col3Center, headerY, 'center'
    );

    // Lignes horizontales du tableau
    for (let i = 0; i <= nbRows; i++) {
      createHLine(TABLE_LEFT, TABLE_TOP + i * ROW_HEIGHT, TABLE_WIDTH);
    }

    // Lignes verticales internes
    createVLine(TABLE_LEFT + COL1_WIDTH, TABLE_TOP, tableHeight);
    createVLine(TABLE_LEFT + COL1_WIDTH + COL2_WIDTH, TABLE_TOP, tableHeight);

    // Contenu du tableau
    for (let i = 0; i < nbRows; i++) {
      const rowY = TABLE_TOP + i * ROW_HEIGHT + ROW_HEIGHT / 2 - 6;
      const d = days[i] || {};

      if (d.date) {
        createTextLayer(
          `<span style="font-size:14px;">${formatDate(d.date)}</span>`,
          col1Center, rowY, 'center'
        );
      }
      if (d.start || d.end) {
        createTextLayer(
          `<span style="font-size:14px;">${formatTimeDisplay(d.start)} – ${formatTimeDisplay(d.end)}</span>`,
          col2Center, rowY, 'center'
        );
      }
      if (d.titre) {
        createTextLayer(
          `<span style="font-size:14px;">${d.titre}</span>`,
          col3Center, rowY, 'center'
        );
      }
    }

    // Total d'heures
    const totalY = TABLE_TOP + tableHeight + 15;
    const heureLabel = (totalHours === 1) ? 'heure' : 'heures';
    const totalStr = totalHours > 0
      ? `${totalHours.toString().replace('.', ',')} ${heureLabel}`
      : '0 heure';

    createTextLayer(
      `<span style="font-weight:bold; font-size:14px;">Total d'heures de formation : ${totalStr}</span>`,
      TABLE_LEFT + TABLE_WIDTH, totalY, 'right'
    );

    // Bloc signature (a droite)
    const signBlockY = totalY + 40;

    createTextLayer(
      `<span style="font-weight:bold; font-size:14px;">Fait a ${faitLieu || 'Ettelbruck'}, le ${formatDate(faitDate) || 'JJ/MM/AAAA'}</span>`,
      SIGN_CENTER_X, signBlockY, 'center'
    );

    createTextLayer(
      '<span style="font-size:12px;">(Signature et cachet)</span>',
      SIGN_CENTER_X, signBlockY + 20, 'center'
    );

    if (signName) {
      createTextLayer(
        `<span style="font-size:13px;">${signName}</span>`,
        SIGN_CENTER_X, signBlockY + 40, 'center'
      );
    }

    createSignatureImage(SIGN_CENTER_X, signBlockY + 60);

    updateTotal();
  }

  /******************************
   * EXPORT PDF HAUTE QUALITE
   ******************************/

  async function generatePDF() {
    try {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("La bibliotheque jsPDF n'est pas chargee");
        return;
      }

      // Regenerer l'apercu pour s'assurer qu'il est a jour
      generatePreview();

      // Attendre que toutes les images soient chargees
      await new Promise(resolve => setTimeout(resolve, 500));

      const preview = document.getElementById('preview');

      // Utiliser html2canvas avec une haute resolution
      const canvas = await html2canvas(preview, {
        scale: 3, // Haute resolution
        useCORS: true,
        allowTaint: true,
        logging: false,
        backgroundColor: '#ffffff'
      });

      const imgData = canvas.toDataURL('image/png', 1.0);
      const { jsPDF } = window.jspdf;

      // Creer PDF en A4 paysage
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });

      const pdfWidth = pdf.internal.pageSize.getWidth();   // 297 mm
      const pdfHeight = pdf.internal.pageSize.getHeight(); // 210 mm

      // Ajouter l'image avec la meilleure qualite
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight, '', 'FAST');

      // Nom du fichier avec la date
      const today = new Date();
      const filename = `certificat_${today.toISOString().split('T')[0]}.pdf`;
      pdf.save(filename);

    } catch (error) {
      console.error('Erreur generation PDF:', error);
      alert("Une erreur s'est produite lors de la generation du PDF. Consultez la console (F12) pour plus de details.");
    }
  }

  /******************************
   * INITIALISATION
   ******************************/

  window.addEventListener('load', () => {
    document.getElementById('lieuFormation').value = 'Ettelbruck';
    document.getElementById('faitLieu').value = 'Ettelbruck';
    generatePreview();
  });

  // Regenerer l'apercu quand les champs changent
  document.addEventListener('DOMContentLoaded', () => {
    const inputs = document.querySelectorAll('input[type="text"], input[type="date"], input[type="time"]');
    inputs.forEach(input => {
      input.addEventListener('input', generatePreview);
    });
  });
</script>

</body>
</html>
